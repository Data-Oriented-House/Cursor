"use strict";(self.webpackChunkdocs=self.webpackChunkdocs||[]).push([[246],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>f});var r=t(67294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function o(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?o(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):o(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},o=Object.keys(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(r=0;r<o.length;r++)t=o[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var u=r.createContext({}),l=function(e){var n=r.useContext(u),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},c=function(e){var n=l(e.components);return r.createElement(u.Provider,{value:n},e.children)},p="mdxType",h={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},d=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,o=e.originalType,u=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),p=l(t),d=a,f=p["".concat(u,".").concat(d)]||p[d]||h[d]||o;return t?r.createElement(f,s(s({ref:n},c),{},{components:t})):r.createElement(f,s({ref:n},c))}));function f(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var o=t.length,s=new Array(o);s[0]=d;var i={};for(var u in n)hasOwnProperty.call(n,u)&&(i[u]=n[u]);i.originalType=e,i[p]="string"==typeof e?e:a,s[1]=i;for(var l=2;l<o;l++)s[l]=t[l];return r.createElement.apply(null,s)}return r.createElement.apply(null,t)}d.displayName="MDXCreateElement"},61668:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>u,contentTitle:()=>s,default:()=>h,frontMatter:()=>o,metadata:()=>i,toc:()=>l});var r=t(87462),a=(t(67294),t(3905));const o={sidebar_position:2},s="Getting Started",i={unversionedId:"Tutorial",id:"Tutorial",title:"Getting Started",description:"I think it would be fun to encode information about a spaceship. Let's start with our spaceship type:",source:"@site/docs/Tutorial.md",sourceDirName:".",slug:"/Tutorial",permalink:"/Cursor/docs/Tutorial",draft:!1,editUrl:"https://github.com/Data-Oriented-House/Cursor/edit/main/docs/Tutorial.md",tags:[],version:"current",sidebarPosition:2,frontMatter:{sidebar_position:2},sidebar:"defaultSidebar",previous:{title:"Installation",permalink:"/Cursor/docs/intro"}},u={},l=[{value:"Encoding",id:"encoding",level:2},{value:"Choosing The Right Type",id:"choosing-the-right-type",level:3},{value:"Numbers",id:"numbers",level:4},{value:"Strings",id:"strings",level:4},{value:"Booleans",id:"booleans",level:4},{value:"VLQs",id:"vlqs",level:4},{value:"Choosing The Right Size",id:"choosing-the-right-size",level:3},{value:"Strings",id:"strings-1",level:3},{value:"Variable Length Quantities",id:"variable-length-quantities",level:3},{value:"Bitpacking",id:"bitpacking",level:3},{value:"Results",id:"results",level:3},{value:"Decoding",id:"decoding",level:2}],c={toc:l},p="wrapper";function h(e){let{components:n,...t}=e;return(0,a.kt)(p,(0,r.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("h1",{id:"getting-started"},"Getting Started"),(0,a.kt)("p",null,"I think it would be fun to encode information about a spaceship. Let's start with our spaceship type:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},"type Spaceship = {\n    locked: boolean,\n    occupied: boolean,\n    underMaintenance: boolean,\n    name: string,\n    crew: { string },\n    onlineDuration: number,\n    hullIntegrity: number,\n}\n\nlocal function spaceshipToBuffer(spaceship: Spaceship): buffer\n    -- todo\nend\n\nlocal function spaceshipFromBuffer(buf: buffer): Spaceship\n    -- todo\nend\n")),(0,a.kt)("h2",{id:"encoding"},"Encoding"),(0,a.kt)("p",null,"First we'll create a new cursor instance that we eventually plan to trim back down into a buffer once we are done."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},"local Cursor = require(...)\n\nlocal function spaceshipToBuffer(spaceship: Spaceship): buffer\n    local cursor = Cursor.new()\n\n    -- todo\n\n    return cursor:tobuffer() -- or Cursor.tobuffer(cursor) if you perfer the procedural api\nend\n")),(0,a.kt)("h3",{id:"choosing-the-right-type"},"Choosing The Right Type"),(0,a.kt)("p",null,"Now let's push some data into the buffer and advance the cursor. To start, we'll push how long the ship has been online in whole seconds, implying we want an unsigned integer. The general rundown goes:"),(0,a.kt)("h4",{id:"numbers"},"Numbers"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Need fractions? Use floats."),(0,a.kt)("li",{parentName:"ul"},"Need negatives? Use signed integers."),(0,a.kt)("li",{parentName:"ul"},"Else, use unsigned integers."),(0,a.kt)("li",{parentName:"ul"},"Need Enums? Don't use strings or metadatas, assign each one a number and use a u1.")),(0,a.kt)("h4",{id:"strings"},"Strings"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Best for unique names, descriptions, titles, user inputs, or bodies of text.")),(0,a.kt)("h4",{id:"booleans"},"Booleans"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},"Best for flags or other stateful yes/no information.")),(0,a.kt)("h4",{id:"vlqs"},"VLQs"),(0,a.kt)("ul",null,(0,a.kt)("li",{parentName:"ul"},(0,a.kt)("a",{parentName:"li",href:"https://en.wikipedia.org/wiki/Variable-length_quantity"},"Variable Length Quantities")," are best for unsigned integer values that can span single bytes to many bytes in size."),(0,a.kt)("li",{parentName:"ul"},"Typically used for sizes of runtime arrays and strings.")),(0,a.kt)("h3",{id:"choosing-the-right-size"},"Choosing The Right Size"),(0,a.kt)("p",null,"To figure out the largest kinds of numbers we need to store, let's think of a spaceship that has been online the longest. How about we say the longest online spaceship lasted 3 months before scheduled maintenance. There are 60 seconds in a minute, 60 minutes in an hour, 24 hours in a day, 7 days in a week, 4 weeks in a month, and we want 3 months. ",(0,a.kt)("inlineCode",{parentName:"p"},"60 * 60 * 24 * 7 * 4 * 3 = 7257600"),". That's a big number! To figure out how many bytes we'd need to represent that non-zero number, we can use ",(0,a.kt)("inlineCode",{parentName:"p"},"ceil(log256(1 + number))"),". To calculate it: ",(0,a.kt)("inlineCode",{parentName:"p"},"ceil(log256(1 + 7,257,600)) = 3"),"."),(0,a.kt)("p",null,"Our worst case says we need at least 3 bytes to store how long the spaceship has been online. Now that we have 3 bytes, we can quickly calculate the maximum number we can represent to know if this choice will scale well past our expectations. We calculate that using ",(0,a.kt)("inlineCode",{parentName:"p"},"256^bytes - 1"),". Doing so we get: ",(0,a.kt)("inlineCode",{parentName:"p"},"256^3 - 1 = 16,777,215"),". That's more than twice the value we came up with, meaning we are more than safe to use ",(0,a.kt)("inlineCode",{parentName:"p"},"3 bytes"),"!"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},"local function spaceshipToBuffer(spaceship: Spaceship): buffer\n    local cursor = Cursor.new()\n\n    -- If you want to avoid metatable overhead Cursor has a procedural api\n    Cursor.pushu3(cursor, spaceship.onlineDuration) -- seconds\n\n    return cursor:tobuffer()\nend\n")),(0,a.kt)("p",null,"Great. Now let's follow a similar procedure when choosing the current Hull Integrity, which is a percentage. Percentages are floating point numbers between 0 and 1. Because of this fine middleground we can store great precision using only ",(0,a.kt)("inlineCode",{parentName:"p"},"4 bytes"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},"local function spaceshipToBuffer(spaceship: Spaceship): buffer\n    local cursor = Cursor.new()\n\n    -- If you want to avoid metatable overhead Cursor has a procedural api\n    Cursor.pushu3(cursor, spaceship.onlineDuration) -- seconds\n    --? Or you can save yourself some typing and use the : syntax with the object api\n    cursor:pushf4(spaceship.hullIntegrity) -- % of structural integrity\n\n    return cursor:tobuffer()\nend\n")),(0,a.kt)("h3",{id:"strings-1"},"Strings"),(0,a.kt)("p",null,"Now we need to encode the name of the spaceship. This one is ironically the easiest to think about since the hard part of managing lengths is handled automatically for us."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},"local function spaceshipToBuffer(spaceship: Spaceship): buffer\n    local cursor = Cursor.new()\n\n    Cursor.pushu3(cursor, spaceship.onlineDuration)\n    --? And with the object api you can chain pushes quite easily\n    cursor:pushf4(spaceship.hullIntegrity):pushstr(spaceship.name)\n\n    return cursor:tobuffer()\nend\n")),(0,a.kt)("h3",{id:"variable-length-quantities"},"Variable Length Quantities"),(0,a.kt)("p",null,"Last but not least we need to encode the names of each crew member. This one we will have to manage the count on our own, but that's ok, we have all the tools to do it efficiently. To start, we want to iterate over every crew member's name and push them onto the cursor. Then we want to push how many crew members there are so we know how many crew members to pop off when reading the data."),(0,a.kt)("p",null,"If we can guarantee our spaceships will always have less than 256 crew members, then we can use a 1  byte unsigned integer. However, I think it would be more interesting if we had really big spaceships that could fit potentially thousands of people. That's two bytes, but some ships won't need that many. This is where we can use something called a ",(0,a.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Variable-length_quantity"},"Variable Length Quantity")," to store how many crew members we have. It will use 1 byte up to 127 members, then 2 bytes up to 16383 members, which is considerably more than we'll ever need."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},"local function spaceshipToBuffer(spaceship: Spaceship): buffer\n    local cursor = Cursor.new()\n        :pushu3(spaceship.onlineDuration)\n        :pushf4(spaceship.hullIntegrity)\n        :pushstr(spaceship.name)\n\n    for _, name in spaceship.crew do\n        cursor:pushstr(name)\n    end\n    cursor:pushvlq(#spaceship.crew)\n\n    return cursor:tobuffer()\nend\n")),(0,a.kt)("p",null,"It is important that we put the VLQ ",(0,a.kt)("em",{parentName:"p"},"after")," the strings because when we start popping off data, the cursor will first read what was pushed last. We need to know how many names there are before we can pop off each name."),(0,a.kt)("h3",{id:"bitpacking"},"Bitpacking"),(0,a.kt)("p",null,"Lastly we have three booleans in our spaceship type that keep track of its status: ",(0,a.kt)("inlineCode",{parentName:"p"},"locked"),", ",(0,a.kt)("inlineCode",{parentName:"p"},"occupied"),", and ",(0,a.kt)("inlineCode",{parentName:"p"},"underMaintenance"),". Each one is either true or false, which is two values. A single bit can store two values, 1 or 0. A byte, which is the smallest unit we can work with, is 8 bits. We can store up to 8 booleans in a single byte!"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},"local function spaceshipToBuffer(spaceship: Spaceship): buffer\n    local cursor = Cursor.new()\n        :pushbool(spaceship.locked, spaceship.occupied, spaceship.underMaintenance)\n        :pushu3(spaceship.onlineDuration)\n        :pushf4(spaceship.hullIntegrity)\n        :pushstr(spaceship.name)\n\n    for _, name in spaceship.crew do\n        cursor:pushstr(name)\n    end\n    cursor:pushvlq(#spaceship.crew)\n\n    return cursor:tobuffer()\nend\n")),(0,a.kt)("h3",{id:"results"},"Results"),(0,a.kt)("p",null,"We have now finished encoding our spaceship into a buffer using a Cursor! Let's use the pretty print cursor function to see what our results are for a given spaceship:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},'local function spaceshipToBuffer(spaceship: Spaceship): buffer\n    local cursor = Cursor.new()\n        :pushbool(spaceship.locked, spaceship.occupied, spaceship.underMaintenance)\n        :pushu3(spaceship.onlineDuration)\n        :pushf4(spaceship.hullIntegrity)\n        :pushstr(spaceship.name)\n\n    for _, name in spaceship.crew do\n        cursor:pushstr(name)\n    end\n    cursor:pushvlq(#spaceship.crew):print()\n\n    return cursor:tobuffer()\nend\n\nlocal buf = spaceshipToBuffer {\n    locked = false,\n    occupied = true,\n    underMaintenance = false,\n    onlineDuration = 1677726,\n    hullIntegrity = 0.1,\n    name = "Degasi",\n    crew = { "Paul Torgal", "Bart Torgal", "Marguerit Maida" }\n}\n')),(0,a.kt)("p",null,"Our pretty printed output:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre"},'Len: 60\nPos: 56\nBuf: { 2 158 153 25 205 204 204 61 68 101 103 97 115 105 134 80 97 117 108 32 84 111 114 103 97 108 139 66 97 114 116 32 84 111 114 103 97 108 139 77 97 114 103 117 101 114 105 116 32 77 97 105 100 97 143 131 0 0 0 0 }\n                                                                                                                                                                                                                 ^\nWe can see exactly what we we pushed onto the cursor here in bytes! Let\'s analyze it.\n\nflags\n(2 = 01000000)    locked 0b1, occupied 0b01, undermaintenance 0b001\n\nnumbers\n(158 153 25)        onlineDuration 1677726u8\n(205 204 204 61)    hullIntegrity 0.1f\n\nstrings\n(68 101 103 97 115 105 | 134)                                    name "Degasi" | vlq 6\n(80 97 117 108 32 84 111 114 103 97 108 | 139)                   crew "Paul Torgal" | vlq 11\n(66 97 114 116 32 84 111 114 103 97 108 | 139)                   crew "Bart Torgal" | vlq 11\n(77 97 114 103 117 101 114 105 116 32 77 97 105 100 97 | 143)    crew "Marguerit Maida" | vlq 15 \n\ncrew count\n(131)    vlq 3\n')),(0,a.kt)("h2",{id:"decoding"},"Decoding"),(0,a.kt)("p",null,"Now that we know how to push data into the cursor and the mindset to do so, this part should be pretty easy! Let's start by creating a cursor from a buffer created by ",(0,a.kt)("inlineCode",{parentName:"p"},"spaceshipToBuffer"),"."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},"local function spaceshipFromBuffer(buf: buffer): Spaceship\n    local cursor = Cursor.frombuffer(buf)\n\n    return {\n        -- todo\n    }\nend\n")),(0,a.kt)("p",null,"Now the important thing here is that we pop our data in the opposite order we pushed it. For every push function there is a pop function, so the rest should be self explanatory. let's see the final results:"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},"local function spaceshipFromBuffer(buf: buffer): Spaceship\n    local cursor = Cursor.frombuffer(buf)\n\n    local crewCount = cursor:popvlq()\n    local crew = table.create(crewCount)\n    for i = crewCount, 1, -1 do\n        crew[i] = cursor:popstr()\n    end\n\n    local name = cursor:popstr()\n    local hullIntegrity = cursor:popf4()\n    local onlineDuration = cursor:popu3()\n\n    local locked, occupied, underMaintenance = cursor:popbool()\n\n    return {\n        locked = locked,\n        occupied = occupied,\n        underMaintenance = underMaintenance,\n        onlineDuration = onlineDuration,\n        hullIntegrity = hullIntegrity,\n        name = name,\n        crew = crew,\n    }\nend\n")),(0,a.kt)("p",null,"We can now bask in our spaceship serdes implementation!"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-lua"},'type Spaceship = {\n    locked: boolean,\n    occupied: boolean,\n    underMaintenance: boolean,\n    name: string,\n    crew: { string },\n    onlineDuration: number,\n    hullIntegrity: number,\n}\n\nlocal function spaceshipToBuffer(spaceship: Spaceship): buffer\n    local cursor = Cursor.new()\n        :pushbool(spaceship.locked, spaceship.occupied, spaceship.underMaintenance)\n        :pushu3(spaceship.onlineDuration)\n        :pushf4(spaceship.hullIntegrity)\n        :pushstr(spaceship.name)\n\n    for _, name in spaceship.crew do\n        cursor:pushstr(name)\n    end\n    cursor:pushvlq(#spaceship.crew):print()\n\n    return cursor:tobuffer()\nend\n\nlocal function spaceshipFromBuffer(buf: buffer): Spaceship\n    local cursor = Cursor.frombuffer(buf)\n\n    local crewCount = cursor:popvlq()\n    local crew = table.create(crewCount)\n    for i = crewCount, 1, -1 do\n        crew[i] = cursor:popstr()\n    end\n\n    local name = cursor:popstr()\n    local hullIntegrity = cursor:popf4()\n    local onlineDuration = cursor:popu3()\n\n    local locked, occupied, underMaintenance = cursor:popbool()\n\n    return {\n        locked = locked,\n        occupied = occupied,\n        underMaintenance = underMaintenance,\n        onlineDuration = onlineDuration,\n        hullIntegrity = hullIntegrity,\n        name = name,\n        crew = crew,\n    }\nend\n\nlocal buf = spaceshipToBuffer {\n    locked = false,\n    occupied = true,\n    underMaintenance = false,\n    onlineDuration = 1677726,\n    hullIntegrity = 0.1,\n    name = "Degasi",\n    crew = { "Paul Torgal", "Bart Torgal", "Marguerit Maida" }\n} -- Into the byte buffer you go\n\nlocal spaceship = spaceshipFromBuffer(buf) -- Tada! Back to normal\n')))}h.isMDXComponent=!0}}]);